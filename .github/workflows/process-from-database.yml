name: Process Videos from Database to R2

on:
  workflow_dispatch:
  schedule:
    # Cháº¡y tá»± Ä‘á»™ng má»—i giá» Ä‘á»ƒ xá»­ lÃ½ videos má»›i
    - cron: '0 * * * *'

jobs:
  process-videos:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq bc curl

      - name: Install Python dependencies
        run: |
          pip3 install --upgrade pip
          pip3 install -r requirements.txt

      - name: Setup working directories
        run: |
          mkdir -p videos
          mkdir -p output
          mkdir -p scripts
          chmod +x scripts/*.sh 2>/dev/null || true

      - name: Run video processor
        env:
          # Database Configuration
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

          # Cloudflare R2 Configuration
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}

          # AI/TTS Configuration
          HUGGINGFACE_ENDPOINT: ${{ secrets.HUGGINGFACE_ENDPOINT || 'https://router.huggingface.co/v1/chat/completions' }}
          HUGGINGFACE_MODEL: ${{ secrets.HUGGINGFACE_MODEL || 'deepseek-ai/DeepSeek-V3.2-Exp' }}
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          ZALO_API_KEY: ${{ secrets.ZALO_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
        run: |
          python3 process_videos.py

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸŽ¬ Video Processing Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Videos have been processed from database and uploaded to Cloudflare R2." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details on processed products." >> $GITHUB_STEP_SUMMARY
